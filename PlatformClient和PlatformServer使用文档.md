# PlatformClient和PlatformServer使用文档

## 目录
1. [PlatformClient使用文档](#platformclient使用文档)
2. [PlatformServer使用文档](#platformserver使用文档)
3. [MySQL数据库创建操作](#mysql数据库创建操作)

---

## PlatformClient使用文档

### 简介

PlatformClient是一个安全密钥管理系统的客户端应用程序，主要用于与服务器进行密钥协商、密钥校验和密钥注销等操作。该系统采用了多种加密技术，包括RSA非对称加密和AES对称加密，确保密钥传输和存储的安全性。

PlatformClient通过TCP/IP协议与PlatformServer进行通信，使用Protocol Buffers定义的消息格式进行数据交换。客户端使用共享内存来存储和管理密钥信息，提高了密钥访问的效率。

### 系统要求

- 操作系统：Windows/Linux
- C++编译器（支持C++11或更高版本）
- CMake构建工具
- Protocol Buffers库
- OpenSSL库（用于加密操作）

### 安装与配置

#### 1. 编译安装

```bash
# 进入项目目录
cd platformClient

# 创建构建目录
mkdir build && cd build

# 使用CMake构建项目
cmake ..

# 编译
make
```

#### 2. 配置文件

客户端配置文件为`client.json`，内容如下：

```json
{
    "ServerID":"9988",
    "ClientID":"2256",
    "ServerIP":"192.168.149.129",
    "Port":8989,
    "ShmKey":"/usr/local/bin",
    "ShmMaxNode":1
}
```

配置参数说明：
- `ServerID`：服务器标识ID
- `ClientID`：客户端标识ID
- `ServerIP`：服务器IP地址
- `Port`：服务器端口号
- `ShmKey`：共享内存键值路径
- `ShmMaxNode`：共享内存最大节点数

### 使用方法

#### 1. 启动客户端

```bash
# 在build/bin目录下
./client
```

#### 2. 功能菜单

启动客户端后，会显示以下功能菜单：

```
*************************************************************
*************************************************************
*     1.密钥协商                                            *
*     2.密钥校验                                            *
*     3.密钥注销                                            *
*     0.退出系统                                            *
*************************************************************
*************************************************************
选择:
```

#### 3. 功能说明

##### 3.1 密钥协商

选择菜单中的"1"进行密钥协商。密钥协商是客户端与服务器建立安全通信的第一步，过程如下：

1. 客户端生成随机字符串
2. 使用服务器RSA公钥加密随机字符串
3. 将加密后的数据发送给服务器
4. 服务器解密并验证数据
5. 服务器生成对称密钥，使用客户端RSA公钥加密后返回
6. 客户端解密获取对称密钥
7. 将密钥信息存储到共享内存中

成功执行后，控制台会显示"密钥协商成功！"，否则显示"密钥协商失败！"。

##### 3.2 密钥校验

选择菜单中的"2"进行密钥校验。密钥校验用于验证客户端和服务器之间共享的密钥是否仍然有效，过程如下：

1. 客户端从共享内存中读取密钥信息
2. 生成校验数据
3. 使用共享密钥加密校验数据
4. 将加密后的数据发送给服务器
5. 服务器使用共享密钥解密并验证数据
6. 返回校验结果

##### 3.3 密钥注销

选择菜单中的"3"进行密钥注销。密钥注销用于废弃不再使用的密钥，过程如下：

1. 客户端向服务器发送密钥注销请求
2. 服务器标记密钥为无效状态
3. 客户端从共享内存中删除密钥信息

##### 3.4 退出系统

选择菜单中的"0"退出客户端程序。

### 工作流程

#### 密钥协商流程

1. 客户端启动并加载配置文件
2. 用户选择"密钥协商"功能
3. 客户端生成随机字符串
4. 客户端使用服务器RSA公钥加密随机字符串
5. 客户端将加密数据发送给服务器
6. 服务器接收并解密数据
7. 服务器验证数据有效性
8. 服务器生成对称密钥
9. 服务器使用客户端RSA公钥加密对称密钥
10. 服务器将加密后的对称密钥发送给客户端
11. 客户端接收并解密获取对称密钥
12. 客户端将密钥信息存储到共享内存
13. 客户端显示操作结果

#### 密钥校验流程

1. 客户端启动并加载配置文件
2. 用户选择"密钥校验"功能
3. 客户端从共享内存中读取密钥信息
4. 客户端生成校验数据
5. 客户端使用共享密钥加密校验数据
6. 客户端将加密数据发送给服务器
7. 服务器接收并使用共享密钥解密数据
8. 服务器验证数据有效性
9. 服务器返回校验结果
10. 客户端显示校验结果

#### 密钥注销流程

1. 客户端启动并加载配置文件
2. 用户选择"密钥注销"功能
3. 客户端向服务器发送密钥注销请求
4. 服务器接收请求并标记密钥为无效状态
5. 服务器返回操作结果
6. 客户端从共享内存中删除密钥信息
7. 客户端显示操作结果

### 注意事项

1. 确保服务器已启动并正常运行
2. 确保客户端配置文件中的服务器IP地址和端口号正确
3. 确保共享内存路径存在且具有适当的访问权限
4. 密钥协商成功后才能进行密钥校验操作
5. 密钥注销后，该密钥将无法再使用


## PlatformServer使用文档

### 简介

PlatformServer是一个安全密钥管理系统的服务器端应用程序，主要用于处理客户端的密钥协商、密钥校验和密钥注销等请求。该系统采用了多种加密技术，包括RSA非对称加密和AES对称加密，确保密钥传输和存储的安全性。

PlatformServer通过TCP/IP协议接收客户端连接，使用Protocol Buffers定义的消息格式进行数据交换。服务器使用MySQL数据库存储密钥相关信息，并通过共享内存机制提供高效的密钥访问服务。服务器采用多线程架构，能够同时处理多个客户端的请求。

### 系统要求

- 操作系统：Windows/Linux
- C++编译器（支持C++11或更高版本）
- CMake构建工具
- Protocol Buffers库
- OpenSSL库（用于加密操作）
- MySQL数据库服务器

### 安装与配置

#### 1. 数据库准备

确保MySQL数据库服务器已安装并运行，创建数据库和表结构（详见[MySQL数据库创建操作](#mysql数据库创建操作)部分）。

#### 2. 编译安装

```bash
# 进入项目目录
cd platformServer

# 创建构建目录
mkdir build && cd build

# 使用CMake构建项目
cmake ..

# 编译
make
```

#### 3. 配置文件

服务器配置文件为`server.json`，内容如下：

```json
{
    "serverID":"9988",
    "dbUser":"root",
    "dbPasswd":"123",
    "dbHost":"localhost",
    "dbPort":33060,
    "dbName":"SECMNG",
    "port":8989,
    "maxnode":10,
    "shmkey":"/home/bin"
}
```

配置参数说明：
- `serverID`：服务器标识ID
- `dbUser`：数据库用户名
- `dbPasswd`：数据库密码
- `dbHost`：数据库主机地址
- `dbPort`：数据库端口号
- `dbName`：数据库名称
- `port`：服务器监听端口号
- `maxnode`：共享内存最大节点数
- `shmkey`：共享内存键值路径

### 使用方法

#### 1. 启动服务器

```bash
# 在build/bin目录下
./server
```

服务器启动后会监听指定端口，等待客户端连接。

#### 2. 功能说明

##### 2.1 密钥协商

服务器接收客户端的密钥协商请求，处理流程如下：

1. 接收客户端发送的加密随机字符串
2. 使用服务器RSA私钥解密数据
3. 验证数据有效性
4. 生成对称密钥
5. 使用客户端RSA公钥加密对称密钥
6. 将加密后的对称密钥发送给客户端
7. 将密钥信息存储到数据库和共享内存中

##### 2.2 密钥校验

服务器接收客户端的密钥校验请求，处理流程如下：

1. 接收客户端发送的加密校验数据
2. 根据客户端ID和服务器ID从数据库中查询密钥
3. 使用查询到的密钥解密数据
4. 验证数据有效性
5. 返回校验结果

##### 2.3 密钥注销

服务器接收客户端的密钥注销请求，处理流程如下：

1. 接收客户端发送的密钥注销请求
2. 根据客户端ID和服务器ID从数据库中查询密钥
3. 将密钥状态标记为无效
4. 更新数据库中的密钥信息
5. 返回操作结果

### 工作流程

#### 服务器启动流程

1. 服务器启动并加载配置文件
2. 初始化数据库连接
3. 初始化共享内存
4. 创建TCP服务器并开始监听指定端口
5. 创建线程池
6. 等待客户端连接

#### 密钥协商流程

1. 服务器接收客户端连接
2. 接收客户端发送的密钥协商请求
3. 解析请求数据
4. 使用服务器RSA私钥解密随机字符串
5. 验证数据有效性
6. 生成对称密钥
7. 使用客户端RSA公钥加密对称密钥
8. 将加密后的对称密钥发送给客户端
9. 将密钥信息存储到数据库和共享内存
10. 发送操作结果给客户端

#### 密钥校验流程

1. 服务器接收客户端连接
2. 接收客户端发送的密钥校验请求
3. 解析请求数据
4. 根据客户端ID和服务器ID从数据库中查询密钥
5. 使用查询到的密钥解密校验数据
6. 验证数据有效性
7. 发送校验结果给客户端

#### 密钥注销流程

1. 服务器接收客户端连接
2. 接收客户端发送的密钥注销请求
3. 解析请求数据
4. 根据客户端ID和服务器ID从数据库中查询密钥
5. 将密钥状态标记为无效
6. 更新数据库中的密钥信息
7. 发送操作结果给客户端

### 系统架构

#### 1. 多线程架构

PlatformServer采用多线程架构处理客户端请求，主要包含以下线程：

- 主线程：负责监听客户端连接
- 工作线程池：处理客户端请求
- 密钥协商线程：专门处理密钥协商请求

#### 2. 数据存储

- MySQL数据库：持久化存储密钥信息
- 共享内存：提供高效的密钥访问服务

#### 3. 通信协议

服务器使用Protocol Buffers定义的消息格式与客户端进行通信：

```protobuf
message RequestMsg {
  int32 cmdType= 1;
  bytes clientID = 2;
  bytes serverID = 3;
  bytes sign = 4;
  bytes data = 5;
}

message RespondMsg
{
    bool status = 1;
    int32 seckeyID = 2;
    bytes clientID = 3;
    bytes serverID = 4;
    bytes data = 5;
}
```

### 注意事项

1. 确保MySQL数据库服务器已启动并可访问
2. 确保数据库配置正确，包括用户名、密码、数据库名等
3. 确保共享内存路径存在且具有适当的访问权限
4. 确保服务器监听端口未被其他程序占用
5. 定期备份数据库以防数据丢失

### 常见问题

#### Q: 服务器启动失败怎么办？

A: 请检查以下几点：
- MySQL数据库是否正常运行
- 数据库配置是否正确
- 共享内存路径是否存在
- 服务器监听端口是否被占用

#### Q: 客户端无法连接到服务器怎么办？

A: 请检查以下几点：
- 服务器是否已启动
- 网络连接是否正常
- 防火墙是否阻止了连接
- 客户端配置的服务器IP和端口是否正确

#### Q: 如何增加服务器的并发处理能力？

A: 可以通过以下方式提高服务器并发处理能力：
- 增加线程池中的线程数量
- 优化数据库查询性能
- 使用更高性能的服务器硬件

#### Q: 如何修改服务器配置？

A: 编辑`server.json`配置文件，修改相应字段的值，然后重启服务器。

### 维护与扩展

#### 1. 日志管理

服务器运行过程中会产生日志信息，建议定期检查和清理日志文件，以防磁盘空间不足。

#### 2. 数据库维护

定期备份数据库，清理过期的密钥记录，优化数据库性能。

#### 3. 安全性增强

- 定期更换服务器RSA密钥对
- 加强数据库访问控制
- 实施网络访问控制策略
- 定期更新系统和依赖库以修复安全漏洞

---

## MySQL数据库创建操作

### 简介

本部分详细说明了PlatformServer所需的MySQL数据库创建操作，包括创建数据库、表结构、索引、触发器、存储过程和视图等。这些数据库对象是PlatformServer正常运行的基础。

### 数据库创建脚本
mysql.sql

### 数据库结构说明

#### 1. KEYSN表

- **用途**：存储密钥序列号，用于生成唯一的密钥ID
- **字段**：
  - `ikeysn`：当前密钥序列号（主键）

#### 2. SECNODE表

- **用途**：存储网点信息，包括客户端和服务器节点信息
- **字段**：
  - `id`：网点编号（主键，4位字符）
  - `name`：网点名称（必填）
  - `nodedesc`：网点描述
  - `createtime`：创建时间
  - `authcode`：授权码
  - `state`：状态（0可用，1不可用）

#### 3. SECKEYINFO表

- **用途**：存储密钥信息，记录客户端和服务器之间的密钥关系
- **字段**：
  - `clientid`：客户端网点ID（外键，关联SECNODE表）
  - `serverid`：服务器端网点ID（外键，关联SECNODE表）
  - `keyid`：密钥ID（主键，自增）
  - `createtime`：密钥创建时间
  - `state`：密钥状态
  - `seckey`：密钥内容

#### 4. 索引

- `IX_SECKEYINFO_clientid`：在SECKEYINFO表的clientid字段上创建的索引，提高按客户端ID查询的效率

#### 5. 触发器

- `update_keysn_after_insert`：在向SECKEYINFO表插入新记录后自动更新KEYSN表中的密钥序列号

#### 6. 存储过程

- `GetNextKeyID`：获取下一个可用的密钥ID，并更新序列号

#### 7. 视图

- `ACTIVE_SECKEYS`：展示所有可用的密钥信息，包括客户端和服务器网点的名称

### 数据库使用说明

1. **初始化数据库**：在首次部署PlatformServer时，需要执行上述SQL脚本创建数据库和表结构。

2. **密钥管理**：
   - 密钥ID通过KEYSN表和GetNextKeyID存储过程自动生成和管理
   - 密钥状态通过state字段控制，0表示可用，其他值表示不可用
   - 可以通过ACTIVE_SECKEYS视图快速查看所有可用密钥

3. **网点管理**：
   - 通过SECNODE表管理所有客户端和服务器网点信息
   - 每个网点有唯一的ID、名称和描述信息
   - 网点状态通过state字段控制，0表示可用，1表示不可用

